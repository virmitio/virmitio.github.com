<!DOCTYPE html>

<html lange="en">
<head>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>CoApp - Binding Events to .NET 4.0 Tasks instead of Objects (Part 1)</title>
    <meta name="description" content="">
    <meta name="author" content="Garrett Serack">

    <meta property="og:title" content="CoApp - Binding Events to .NET 4.0 Tasks instead of Objects (Part 1)"/>
    
        <meta property="og:type" content="article"/>
    
    <meta property="og:image" content="http://coapp.org/images/logo-small.png"/>
    <meta property="og:url" content="http://coapp.org/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html"/>
    <meta property="og:site_name" content="CoApp"/>
    <meta property="og:admins" content="CoApp - fearthecowboy"/>

    <meta name="docid" content="news:201104131" />
    <meta name="srclocation" content="https://github.com/coapp/coapp.org/blob/master/src/dynamic/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html.md" />

    <!-- Icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <!-- Shims: IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
        <script async src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link href="/styles/style.css" rel="stylesheet"/>
    <link href="/styles/prettify.css" rel="stylesheet"/>
    <link href="/styles/mediaelementplayer.min.css" rel="stylesheet"  />
    
</head>
<body >
    
    <!-- Scripts -->
    <script src="/scripts/jquery-1.6.4.min.js"></script>
    <script src="/scripts/prettify.js"></script>
    <script src="/scripts/jquery.tweet.js"></script>
    <script src="/scripts/mediaelement-and-player.js"></script>
    <script src="/scripts/bootstrap/bootstrap-dropdown.js"></script>
    <div id="fb-root"></div>
      <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
      </script>
      <script type="text/javascript">
      (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-15630590-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <script>
        // $('#topbar').dropdown();
    </script>
    <!-- Markup -->
    <div class="topbar" data-dropdown="dropdown">
        <div class="fill">
            <div class="container-fluid">
                <h3><a href="/index.html"><image style="margin:0; padding:0; position:absolute; top:2px; left:-2px;" src="/images/logo-small_32x32.png"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CoApp</a></h3>
                <ul>
                      
                        
                        <li typeof="sioc:Page" about="/pages/news.html" class="">
                            <a href="/pages/news.html" property="dc:title">News</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/help.html" class="">
                            <a href="/pages/help.html" property="dc:title">Help</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/packages.html" class="">
                            <a href="/pages/packages.html" property="dc:title">Packages</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/publishers.html" class="">
                            <a href="/pages/publishers.html" property="dc:title">Publishers</a>
                        </li>

                        
                      
                        
                        <li class="dropdown" >
                            <a href="#" class="dropdown-toggle">Developers</a>
                            <ul class="dropdown-menu">
                                <li><a href="/pages/developers">Developer Tutorials</a></li>
                                <li class="divider"></li>
                                <li><a href="http://github.com/coapp"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp Source Repositories</a></li>
                                <li><a href="http://github.com/coapp-packages"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub"> Package Source Repositories</a></li>
                                <li class="divider"></li>
                                <li><a href="https://github.com/coapp/coapp.org/wiki"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > Developer Wiki</a></li>
                                <li><a href="https://github.com/coapp/coapp/issues"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp Bugtracker</a></li>
                                <li><a href="https://github.com/coapp/devtools/issues"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > DevTools Bugtracker</a></li>
                                <li class="divider"></li>
                                <li><a href="http://github.com/organizations/coapp"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp GitHub Home</a></li>
                            </ul>
                        </li>
                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/reference.html" class="">
                            <a href="/pages/reference.html" property="dc:title">Reference</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/about.html" class="">
                            <a href="/pages/about.html" property="dc:title">About</a>
                        </li>

                        
                    
                </ul>
                
                
            </div>
        </div>
    </div>
    <div class="wrapper">
    <div class="container-fluid pushdown">
        <div class="sidebar">
            
        </div> 
        <section id="content" class="content">
        <div class="spanonethird rightsidebox" > <!-- float:right; display: inline; veritical-align:top; -->
            
        </div> 
            <div class="spantwothirds">
            


<span style="display:inline-block;">
    <h1>Binding Events to .NET 4.0 Tasks instead of Objects (Part 1)</h1>
    <p>Apr 13 2011 by <b>Garrett Serack</b> <a href="http://twitter.com/#!/fearthecowboy">@fearthecowboy</a><br>
    <span class="label warning">Tags</span><span style="display:inline-block;">developer,coding</span></p>
</span>
<span style="display:inline-block; float:right;">
    <br><br>
    <span style="margin-top:8px; height;100%; display:inline-block; "><g:plusone href="http://coapp.org/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html"></g:plusone></span>
    <div class="fb-like" style="top:-5px;" data-href="http://coapp.org/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html" data-layout="button_count" data-show-faces="true" data-colorscheme="dark" data-font="tahoma"></div>
</span>  
<hr>
<div id="post" class="post">
    <p>During the development of CoApp, I've enthusiastically embraced the .NET 4.0 <a href="http://msdn.microsoft.com/en-us/library/dd460717.aspx">Task Parallel Library</a> (aka, the <strong>TPL</strong>).  It's a set of APIs that make developers more productive by significantly simplifying the process of adding parallelism and concurrency to applications. I got religion around this last fall when I saw the PDC presentation that Anders Hejlsberg gave on <a href="http://channel9.msdn.com/Events/PDC/PDC10/FT09">The Future of C# and VB</a>.  In there Anders talks about the shift to a fully asynchronous programming methodology. While the technology that he spoke of isn't yet ready for production use today, the Task Parallel Library in .NET 4.0 provides the underlying framework that we can take advantage of right now.<br />Before we get too deep...</p>

<p>I should note that asynchronous code in .NET 4 make rather extensive use of <a href="http://blogs.msdn.com/b/ericwhite/archive/2006/10/03/lambda-expressions.aspx">Lambda Expressions</a> - If you're not familiar with lambdas, you'd better go get familiar, because this stuff is gonna be a tad hard to understand without it. It's ok, I'll wait...</p>

<p>And, I'm not going to go into too much detail about <a href="http://msdn.microsoft.com/en-us/library/dd537609.aspx">the basics of using the TPL</a>; I recommend that you watch Ander's video (to get an idea of the motivation) and perhaps read thru <a href="http://blogs.msdn.com/b/ericlippert/archive/tags/async/">Eric Lippert's blog posts on Asynchrony</a> (and really, start with his earlier posts on <a href="http://blogs.msdn.com/b/ericlippert/archive/tags/continuation+passing+style/">Continuation Passing Style</a>)-if you are a .NET developer, this stuff will change your life.</p>

<p>The following is a simple example for how we start an asynchronous task using the TPL:</p>


<p>
<div class="highlight"><pre><span class="c1">// *** Example Zero ***</span>
<span class="c1">// Starting a task using the TPL</span>
<span class="n">var</span> <span class="n">taskZero</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">q</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span> <span class="n">q</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">q</span><span class="p">--)</span> <span class="p">{</span>
        <span class="c1">// simulate a longer running operation</span>
        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">200</span><span class="p">);</span>

        <span class="c1">// Wish we could tell someone about</span>
        <span class="c1">// what&#39;s going on in this operation</span>
        <span class="c1">// and Writeline is hardly a good idea</span>
        <span class="c1">// when you are in another thread.</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Progress Message from taskZero&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;(Main Thread Completed)======&gt;Press Enter to end.\r\n&quot;</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</pre></div>

<p>

<p>Which will produce output like:</p>

<p><span class="scrollcontainer"><img src="/images/blog/201104131_task_0.png" alt="task_0 output screenshot" title="" /></span></p>

<p>You'll notice that the main thread completes (and is sitting around waiting at the <strong>ReadLine()</strong>) while the Task executes.</p>

<h2>And getting to the point</h2>

<p>Ok, so now I can illustrate some code that I've written as part of CoApp that fills a void where I was creating complex asynchronous operations and wanted to be able to broadcast arbitrary events from that operation, without having to pass an object along to each step in the operation.</p>

<p>Let me put this another way...</p>

<p>I'd like to start an operation-say, "Install a package"-and I'd like the calling context to be able to subscribe to events for that particular operation (regardless of what events the operation directly (or indirectly) broadcasts.  Yes, I <strong>could</strong> create a class that has a bunch events, and pass that from function to function in the entire call tree for that operation, but that would be terribly unwieldy, and frankly, would be a real pain when I wanted to reuse other asynchronous tasks as child tasks, and they may not take the same class for events.</p>

<p>Additionally, that asynchronous operation may spawn off additional asynchronous operations of its own-perhaps to download some dependencies-and it'd be nice to be able to pick up download progress notifications so we could show some UI that keeps the user informed as to what's actually going on.</p>

<p>Hrm... Howsabout I explain this with some code.  Let's assume my little task has an event that it'd like to notify. First, we declare a class for the messages:</p>


<p>
<div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">TestEvents</span> <span class="p">:</span> <span class="n">MessageHandlers</span><span class="p">&lt;</span><span class="n">TestEvents</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">Message1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>

<p>And then an example of the task firing the event:</p>


<p>
<div class="highlight"><pre><span class="c1">// *** Example One ***</span>
<span class="c1">// Firing an event</span>
<span class="n">var</span> <span class="n">taskOne</span> <span class="p">=</span> <span class="n">CoTask</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">q</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span> <span class="n">q</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">q</span><span class="p">--)</span> <span class="p">{</span>
        <span class="c1">// simulate a longer running operation</span>
        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">200</span><span class="p">);</span>

        <span class="c1">// that occasionally notifies anyone who cares to listen.</span>
        <span class="n">TestEvents</span><span class="p">.</span><span class="n">Invoke</span><span class="p">.</span><span class="n">Message1</span><span class="p">(</span><span class="s">&quot;Message From taskOne&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>

<p>Now,  you should notice two things ('specially since I highlighted the lines...). First, I use my own <strong>CoTask</strong> Task factory instead of the TPL's Task-this just lets me track tasks a bit better, and handles some background work for all this stuff. Functionally, it should be identical, and still returns the same Task objects. Second, I can now use the class I created before to fire off a message (in this case, <strong>Message1</strong> takes a <strong>string</strong> and an <strong>int</strong> for parameters) using some mysterious static Invoke dohickey on my <strong>TestEvents</strong> class.</p>

<p>Of course, nothing is listening to the events yet, let's wire that up:</p>


<p>
<div class="highlight"><pre><span class="c1">// perhaps we&#39;ll slack off for a while</span>
<span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">400</span><span class="p">);</span>

<span class="c1">// start listening to messages after the task has started.</span>
<span class="c1">// (we probably missed some!)</span>
<span class="p">((</span><span class="n">TestEvents</span><span class="p">)</span><span class="n">taskOne</span><span class="p">).</span><span class="n">Message1</span> <span class="p">+=</span> <span class="p">(</span><span class="n">aString</span><span class="p">,</span> <span class="n">anInt</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;The Task said: [{0}] and [{1}] &quot;</span><span class="p">,</span> <span class="n">aString</span><span class="p">,</span> <span class="n">anInt</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;(Main Thread Completed)\r\n**Press Enter to end**&quot;</span><span class="p">)</span>
<span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</pre></div>

<p>

<p>When we run this, we'll end up with some rather interesting output:</p>

<p><span class="scrollcontainer"><img src="/images/blog/201104131_task_1.png" alt="task_1 output screenshot" title="" /></span></p>

<p>Shiny! You'll notice in this example, that we've actually missed a couple of events (exacerbated by the <strong>Thread.Sleep()</strong> in line 2.). Regardless, the main thread completes and waits, and you can see my event handler in the lambda expression is getting called.</p>

<p>The beauty of this approach is that we can see how I can launch a longer running operation, and accept events from it, without having to explicitly tell the code in the operation about the event listener.</p>

<p>In the next part as I dig deeper, I'll show how we can ensure we never miss our messages, and how we can listen for more than one at a time.</p>
</div>

<!-- Disqus Comment System -->
<div id="disqus_thread"><div id="dsq-content"></div></div>
<ul id="dsq-comments"></ul>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'coapp'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    
    var disqus_identifier = '/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html';
    var disqus_url = 'http://www.coapp.org/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html';
    var disqus_title = "Binding Events to .NET 4.0 Tasks instead of Objects (Part 1)";
    var disqus_developer = 0; 
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </section>
    </div>  
    <br>    
    <div class="push" ></div>
    </div>
    <footer class="footer">
        <div class="container-fluid">
        <p  style="float:left;">&copy; CoApp Contributors, 2011. 
        <br><sub>The source for this page can be found <a href="https://github.com/coapp/coapp.org/blob/master/src/dynamic/news/2011-04-13-Binding-events-to-NET-4-0-tasks-instead-of-objects-Part-1.html.md">in the github repository.</a></sub>
        </p>
        <p style="float:right;">
            This website was generated on Feb 01 2012 and has 138 documents
        </p>
        </div>
    </footer>
</body>
</html>