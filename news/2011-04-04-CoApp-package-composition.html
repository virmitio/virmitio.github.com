<!DOCTYPE html>

<html lange="en">
<head>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>CoApp - CoApp Package Composition</title>
    <meta name="description" content="">
    <meta name="author" content="Garrett Serack">

    <meta property="og:title" content="CoApp - CoApp Package Composition"/>
    
        <meta property="og:type" content="article"/>
    
    <meta property="og:image" content="http://coapp.org/images/logo-small.png"/>
    <meta property="og:url" content="http://coapp.org/news/2011-04-04-CoApp-package-composition.html"/>
    <meta property="og:site_name" content="CoApp"/>
    <meta property="og:admins" content="CoApp - fearthecowboy"/>

    <meta name="docid" content="news:20110404" />
    <meta name="srclocation" content="https://github.com/coapp/coapp.org/blob/master/src/dynamic/news/2011-04-04-CoApp-package-composition.html.md" />

    <!-- Icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <!-- Shims: IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
        <script async src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link href="/styles/style.css" rel="stylesheet"/>
    <link href="/styles/prettify.css" rel="stylesheet"/>
    <link href="/styles/mediaelementplayer.min.css" rel="stylesheet"  />
    
</head>
<body >
    
    <!-- Scripts -->
    <script src="/scripts/jquery-1.6.4.min.js"></script>
    <script src="/scripts/prettify.js"></script>
    <script src="/scripts/jquery.tweet.js"></script>
    <script src="/scripts/mediaelement-and-player.js"></script>
    <script src="/scripts/bootstrap/bootstrap-dropdown.js"></script>
    <div id="fb-root"></div>
      <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
      </script>
      <script type="text/javascript">
      (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-15630590-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <script>
        // $('#topbar').dropdown();
    </script>
    <!-- Markup -->
    <div class="topbar" data-dropdown="dropdown">
        <div class="fill">
            <div class="container-fluid">
                <h3><a href="/index.html"><image style="margin:0; padding:0; position:absolute; top:2px; left:-2px;" src="/images/logo-small_32x32.png"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CoApp</a></h3>
                <ul>
                      
                        
                        <li typeof="sioc:Page" about="/pages/news.html" class="">
                            <a href="/pages/news.html" property="dc:title">News</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/help.html" class="">
                            <a href="/pages/help.html" property="dc:title">Help</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/packages.html" class="">
                            <a href="/pages/packages.html" property="dc:title">Packages</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/publishers.html" class="">
                            <a href="/pages/publishers.html" property="dc:title">Publishers</a>
                        </li>

                        
                      
                        
                        <li class="dropdown" >
                            <a href="#" class="dropdown-toggle">Developers</a>
                            <ul class="dropdown-menu">
                                <li><a href="/pages/developers">Developer Tutorials</a></li>
                                <li class="divider"></li>
                                <li><a href="http://github.com/coapp"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp Source Repositories</a></li>
                                <li><a href="http://github.com/coapp-packages"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub"> Package Source Repositories</a></li>
                                <li class="divider"></li>
                                <li><a href="https://github.com/coapp/coapp.org/wiki"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > Developer Wiki</a></li>
                                <li><a href="https://github.com/coapp/coapp/issues"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp Bugtracker</a></li>
                                <li><a href="https://github.com/coapp/devtools/issues"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > DevTools Bugtracker</a></li>
                                <li class="divider"></li>
                                <li><a href="http://github.com/organizations/coapp"><img style="margin-bottom:-3px;" src="/images/github.png" title="GitHub" > CoApp GitHub Home</a></li>
                            </ul>
                        </li>
                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/reference.html" class="">
                            <a href="/pages/reference.html" property="dc:title">Reference</a>
                        </li>

                        
                      
                        
                        <li typeof="sioc:Page" about="/pages/about.html" class="">
                            <a href="/pages/about.html" property="dc:title">About</a>
                        </li>

                        
                    
                </ul>
                
                
            </div>
        </div>
    </div>
    <div class="wrapper">
    <div class="container-fluid pushdown">
        <div class="sidebar">
            
        </div> 
        <section id="content" class="content">
        <div class="spanonethird rightsidebox" > <!-- float:right; display: inline; veritical-align:top; -->
            
        </div> 
            <div class="spantwothirds">
            


<span style="display:inline-block;">
    <h1>CoApp Package Composition</h1>
    <p>Apr 04 2011 by <b>Garrett Serack</b> <a href="http://twitter.com/#!/fearthecowboy">@fearthecowboy</a><br>
    <span class="label warning">Tags</span><span style="display:inline-block;">developer</span></p>
</span>
<span style="display:inline-block; float:right;">
    <br><br>
    <span style="margin-top:8px; height;100%; display:inline-block; "><g:plusone href="http://coapp.org/news/2011-04-04-CoApp-package-composition.html"></g:plusone></span>
    <div class="fb-like" style="top:-5px;" data-href="http://coapp.org/news/2011-04-04-CoApp-package-composition.html" data-layout="button_count" data-show-faces="true" data-colorscheme="dark" data-font="tahoma"></div>
</span>  
<hr>
<div id="post" class="post">
    <p>(cross-posted to the <a href="/developers/email.html" title="Mailing Lists">mailing list</a>)</p>

<p>When CoApp packages are installed, they install into a predetermined location based on the package metadata-this ensures that all packages play by the rules, and allow us to use Windows features to support things side-by-side installation of applications (ie, havin' two versions of the same application installed concurrently), and also to ensure that <strong>we never, ever require a reboot</strong> to install software (even if a previous version of the software is currently running).</p>

<p>For most packages, this follows a format something like:</p>


<p>
<div class="highlight"><pre>c:\apps\.installed\PUBLISHERNAME\PRODUCT-VERSION-PLATFORM\
</pre></div>

<p>

<p>which means that for a given package (say, CoApp's command line toolkit) the files would get installed into:</p>


<p>
<div class="highlight"><pre>c:\apps\.installed\OUTERCURVE FOUNDATION\coapp.toolkit-1.0.2.338-any
c:\apps\.installed\OUTERCURVE FOUNDATION\coapp.toolkit-1.0.2.338-any\coapp.exe
</pre></div>

<p>

<p>Of course, this predefined location is nether attractive, nor trivial for the end user (or other software) to use, so we like to ensure that packages can expose themselves in a consistent and familiar manner. The process that CoApp has to accomplish this is called <strong>Package Composition</strong>.</p>

<p>In CoApp V1, Package Composition is fairly limited; it's intended to create canonical directories, EXE links and shortcuts for packages so that they can be easily be referenced by users and developers without much trouble. In CoApp V2, Package Composition will provide a method for publishers to define how third-party plugins, libraries and extensions can be cleanly published without polluting the application's install directory with files that really don't belong there.</p>

<p>In CoApp V1, we see a package expose itself by creating a canonical location for the package and optionally publish EXEs in the PATH. The canonical location for a given (application) package follows the following format:</p>


<p>
<div class="highlight"><pre>c:\apps\PRODUCT\
</pre></div>

<p>

<p>Pretty easy, eh? ... So that means we see CoApp's command line toolkit visible here:</p>


<p>
<div class="highlight"><pre>c:\apps\coapp.toolkit\
c:\apps\coapp.toolkit\coapp.exe
</pre></div>

<p>

<p>And the EXE should show itself in the PATH, by appearing in the common:</p>


<p>
<div class="highlight"><pre>c:\Apps\bin
</pre></div>

<p>

<p>directory (which is placed in the PATH), like this:</p>


<p>
<div class="highlight"><pre>c:\Apps\bin\coapp.exe
</pre></div>

<p>

<p>Of course, we really don't want multiple <em>copies</em> of all these things littering the drive, so we're using NTFS <a href="http://en.wikipedia.org/wiki/Symbolic_link">symbolic links</a> (aka symlinks) to have the file system merely appear that way (somewhat like UNIX).</p>

<h2>Symlinks On Windows</h2>

<p>Starting with Windows Vista, NTFS supports symbolic links (often called soft-links), in a manner extremely similar to UNIX (and brethren). Yay! This is awesome; we can easily use symlinks to redirect the files and directories that we're interested in back to the original installed location (c:\apps.installed...) and not duplicate files.</p>

<p>This is also the secret mojo we've needed to allow applications to install side-by-side with other versions of itself. It turns out that if you run an EXE via a symlink, it doesn't lock the <strong>link</strong>, it locks the <strong>target</strong>. This means we can remove the linked version in c:\apps\bin and create a new link to the new version, and the currently running program doesn't freak out.</p>

<p>Now, my pappy always used to say <strong>"this is all goin' down too easy; I'm still waitin' to find the mouse at the bottom of this can of beans!"</strong></p>

<p>The proverbial mouse in this case is that Windows XP and Windows Server 2003 don't actually support symbolic links-but they do have a couple of thinks we can use to achieve nearly the same goal.</p>

<p>For directories, there are <a href="http://en.wikipedia.org/wiki/NTFS_junction_point">junctions</a>. Junctions are really close to symbolic links (they have some limitations, like you can't have a junction to a file across UNC, and they have to be absolute paths). Fortunately, this is minor potatoes-we are only interested in having directories locally, and we don't need to use relative paths.</p>

<p>For files, it was lookin' like we was plumb out of luck-except we do have something called <a href="http://en.wikipedia.org/wiki/Hard_link">hard links</a>. Hard links actually allow more than one directory entry on the hard disk to physically point to the same file on disk. While this gets around the trouble with actually duplicating the file on disk, if you run an application via the hard link (ie, run c:\apps\bin\coapp.exe ) and try to remove the link, it'll fail while the application is running.</p>

<p>Luckily, there <strong>is</strong> something we can do to a file that is locked. We can move it - or rename it - <strong>even while it's in use</strong>. Using this, we can move the locked file out of the way, create a link to the new version, and we're happy as horses. If the file is locked, we'll queue it up to actually get deleted on reboot (by using <a href="http://msdn.microsoft.com/en-us/library/aa365240(v=vs.85">MoveFileEx</a>.aspx) which stuffs it into the registry at <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\PendingFileRenameOperations</code>).</p>

<p>The only trouble that I can see is when you make a hard-link, there really isn't an efficient way to find out what else is pointing to the same file. We'd need to be able to find linked copies when we want to remove a package, so that the 'linked' versions get cleaned up at package removal time too.</p>

<p>In order to address that, we use another NTFS feature - <a href="http://msdn.microsoft.com/en-us/library/Aa364404">alternate streams</a>. This lets us store a little bit of information with the file itself-in this case, we'll store the other known locations that are linked to the file-so that when we go to remove the 'official' version, we can clean up all the symlinked copies too.</p>
</div>

<!-- Disqus Comment System -->
<div id="disqus_thread"><div id="dsq-content"></div></div>
<ul id="dsq-comments"></ul>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'coapp'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    
    var disqus_identifier = '/news/2011-04-04-CoApp-package-composition.html';
    var disqus_url = 'http://www.coapp.org/news/2011-04-04-CoApp-package-composition.html';
    var disqus_title = "CoApp Package Composition";
    var disqus_developer = 0; 
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </section>
    </div>  
    <br>    
    <div class="push" ></div>
    </div>
    <footer class="footer">
        <div class="container-fluid">
        <p  style="float:left;">&copy; CoApp Contributors, 2011. 
        <br><sub>The source for this page can be found <a href="https://github.com/coapp/coapp.org/blob/master/src/dynamic/news/2011-04-04-CoApp-package-composition.html.md">in the github repository.</a></sub>
        </p>
        <p style="float:right;">
            This website was generated on Feb 01 2012 and has 138 documents
        </p>
        </div>
    </footer>
</body>
</html>